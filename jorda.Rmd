---
title: "jorda"
output: html_document
date: '2022-05-07'
---


```{r,message=FALSE}
library(tidyverse)
library(lpirfs)
library(dplyr)
library(jtools)
library(nlme)

library(broom)
library(scales)
library(truncnorm)
library(ipw)
library(WeightIt)
```

```{r load DB, message=FALSE, warning=FALSE}
library(readr)

ln1 <- read_delim("ln1.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
ia1 <- read_delim("ia1.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
ia2 <- read_delim("ia2.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
ia3 <- read_delim("ia3.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
ia4 <- read_delim("ia4.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
ia5 <- read_delim("ia5.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

attach(ia1)
```

```{r}
# ia6 <- as.data.frame(ia6 %>%
#   arrange(idem, year) %>%  # Sort by firm and tsocn by year
#   group_by(idem) %>%      # Tell dplyr to go within each firm
#   mutate(gdppc_gro = GDP_pc/(lag(GDP_pc)-1),
#          gdp_gro = GDP/(lag(GDP)-1),
#          insde_d = ins_effic/(lag(ins_effic)-1),
#          tot_d = TOT/(lag(TOT)-1),
#          debt_d = Gov_debt/(lag(Gov_debt)-1),
#          redis = Gini_market - Gini_net/Gini_net,
#          pi_m = PIT*mrp_all,
#          pi_a = PIT*arp_mid,
#          rd = sav_gdp*res_1mill,
#          rd1= sav_gdp*RD_gdp,
#          dtrade = Trade-lag(Trade),
#          lgini = lag(Gini_net),
#          lgdpg = lag(gdp_gro),
#          leduc = lag(Education_exp),
#          lkind = lag(Soc_kind), lpay=lag(Soc_payable)))
```

```{r}
#  No CORRER YA DEFINIDO EN VARIABLES

# library(datawizard)
# 
# dm = demean(ia6, select = ~ Gini_net+ gdp_gro, group = "idem", suffix_demean = "_within")
# 
# dm <- dm %>% select(ends_with('_within'))
# 
# colnames(dm)<-gsub("_within","dm",colnames(dm))
# 
# ia1 = cbind(ia1, dm)
# ia2 = cbind(ia2, dm)
# ia3 = cbind(ia3, dm)
# ia4 = cbind(ia4, dm)
# ia5 = cbind(ia5, dm)
# ia6 = cbind(ia6, dm)
# 
# ia1 = select(ia1,-123,-124)

```
Demeaned formula

https://ds4ps.org/pe4ps-textbook/docs/p-040-fixed-effects.html



```{r}
# ia1  <- ia1 %>%
#   group_by(idem) %>%
#   mutate( mean.pit=mean(PIT), pit.demeaned = PIT - mean.pit) %>%
# ungroup()
```


```{r}
# ln1 <- ln1 %>%
#   mutate(dumm = ifelse( year %in% c(1991, 1992, 2000, 2001, 2008, 2009, 2011, 2013), 1, NA))
# 
# ia1 <- ia1 %>%
#   mutate(dumm = ifelse( year %in% c(1991, 1992,2000, 2001, 2008, 2009, 2011, 2013), 1, 0))
# 
# ia2 <- ia2 %>%
#   mutate(dumm = ifelse( year %in% c(1991, 1992,2000, 2001, 2008, 2009, 2011, 2013), 1, 0))

b1 = ia1 %>% select(everything()) %>% filter(year %in% c(1991, 1992, 1993, 2000, 2001, 2008, 2009, 2011, 2012, 2013))
b2 = ia2 %>% select(everything()) %>%  filter(year %in% c(1991, 1992, 1993, 2000, 2001, 2008, 2009, 2011, 2012, 2013))
b3 = ia3 %>% select(everything()) %>% filter(year %in% c(1991, 1992, 1993, 2000, 2001, 2008, 2009, 2011, 2012, 2013))
b4 = ia4 %>% select(everything()) %>% filter(year %in% c(2008, 2009, 2011, 2012, 2013))

bo1 = ia1 %>% select(everything()) %>% filter (year %in% c(1994,1995,1996,1997,1998,2003,2004,2005,2006,2010,2015,2016,2017,2018))
bo2 = ia2 %>% select(everything()) %>% filter (year %in% c(1994,1995,1996,1997,1998,2003,2004,2005,2006,2010,2015,2016,2017,2018))
bo3 = ia3 %>% select(everything()) %>% filter (year %in% c(1994,1995,1996,1997,1998,2003,2004,2005,2006,2010,2015,2016,2017,2018))
bo4 = ia4 %>% select(everything()) %>% filter (year %in% c(1994,1995,1996,1997,1998,2003,2004,2005,2006,2010,2015,2016,2017,2018))
bo5 = ia5 %>% select(everything()) %>% filter (year %in% c(1994,1995,1996,1997,1998,2003,2004,2005,2006,2010,2015,2016,2017,2018))

```

```{r}
get_phat <- function(equation, db) {
    pror1 = glm(equation, data=db, family=binomial(link="probit"), na.action = na.exclude)

    db['phat0'] = predict(pror1,  type = 'response')
    db['invwt'] = db$ed_bb/db$phat0 + (1-db$ed_bb)/(1-db$phat0)
    
    return(db)
}

db_trunc <- function(db) {
    db['phat'] = db$phat0
    
    lo = summary(db$phat0)[1]*1.1
    up = .9*summary(db$phat0)[6]
    
    db <- db %>% mutate(phat = ifelse(phat > up, up , db$phat))
    db <- db %>% mutate(phat = ifelse(phat < lo, lo, db$phat))
    return(db)
    }
```


```{r}
eq_ed <- as.formula(paste("ed_bb ~ lag(Gini_netdm,1) + lag(Education_expdm,1)+ Gov_ex + Trade+Deficit+idem-1", collapse = " + "))

eq_he <- as.formula(paste("he_bb ~ lag(Gini_netdm,1) + Gov_ex+ lag(Health_expdm,1) + Trade+Deficit+idem-1", collapse = " + "))

eq_soc <- as.formula(paste("soc_bb ~ lag(Gini_netdm,1) +lag(Soc_payabledm,1)+ gdp_gro+Gov_ex +Trade+Deficit+idem-1", collapse = " + "))

eq_kind <- as.formula(paste("kind_bb ~ lag(Gini_netdm,1) +lag(Soc_kinddm,1)+Gov_ex +Trade+Deficit+idem-1", collapse = " + "))

eq_prt <- as.formula(paste("prt_bb ~ Gini_netdm +Property_taxesdm +Gov_ex+Trade+Deficit+idem", collapse = " + "))

eq_indtx <- as.formula(paste("indt_bb ~ lag(Gini_netdm,1) + lag(ind_txdm,1) + Gov_ex +Deficit+idem", collapse = " + "))

eq_pit <- as.formula(paste("pit_bb ~ lag(Gini_netdm,3)+lag(PITdm,4)+lag(gdp_grodm,3) + Gov_ex+ Deficit+idem-1", collapse = " + "))

```


```{r}
get_phat(eq_ed, ia1)

# data_frames <- list(ia1, ia2, ia3, ia4, ia5)

# results <- lapply(data_frames, function(df) get_phat(eq_ed, df))

```


```{r}

```



```{r}
pror1 = glm(ed_bb ~ lag(Gini_netdm,1) + lag(Education_expdm,1)+ Gov_ex + Trade+Deficit+idem-1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)

ia1['phat0'] = predict(pror1,  type = 'response')

ia1['invwt'] = ia1$ed_bb/ia1$phat0 + (1-ia1$ed_bb)/(1-ia1$phat0)
```

```{r}
# Load the package
boxplot(ia1$invwt, plot=TRUE)$out

outliers <- boxplot(ia1$invwt, plot=FALSE)$out

boxplot(outliers, plot=TRUE)$out

x<-ia1$invwt

ia1$invwt_2 <- ia1$invwt[-which(x %in% outliers),]

# Create a new column excluding outliers
ia1$invwt_2 <- ifelse(ia1$invwt %in% outliers, NA, ia1$invwt)

```


```{r}
pror1 = glm(he_bb ~ lag(Gini_netdm,1) + Gov_ex+ lag(Health_expdm,1) + Trade+Deficit+idem-1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)

```

```{r}
pror1 = glm(soc_bb ~ lag(Gini_netdm,1) +lag(Soc_payabledm,1)+ gdp_gro+Gov_ex +Trade+Deficit+idem-1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)
```

```{r}
pror1 = glm(kind_bb ~ lag(Gini_netdm,1) +lag(Soc_kinddm,1)+Gov_ex +Trade+Deficit+idem-1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)
```

```{r}
pror1 = glm(prt_bb ~ Gini_netdm +Property_taxesdm +Gov_ex+Trade+Deficit+idem, data=ia1 , family=binomial(link="probit"), na.action = na.exclude)

summ(pror1)
```

```{r}
pror1 = glm(indt_bb ~ lag(Gini_netdm,1) +  lag(ind_txdm,1) + Gov_ex +Deficit+idem, data=ia1 , family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)

```

```{r}
pror1 = glm(pit_bb ~ lag(Gini_netdm,3)+lag(PITdm,4) +lag(gdp_grodm,3) + Gov_ex+ Deficit+idem-1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)
```

## Parte 4

```{r}
select_col <- function(pror1, ia1, cols) {
  esample <- rownames(as.matrix(pror1$fitted.values))

  ia1_e <- ia1[esample,]
  df_ee <- ia1_e %>% select(cols)
  return(df_ee)
}

ia1['phat0'] = predict(pror1, type='response')

esample.n <- nobs(fix)
esample <- rownames(as.matrix(resid(fix)))

esample.n <- nobs(fit)

esample<-rownames(as.matrix(fix$model))
esample.n <- nobs(pr)

ia1_e = ia1[esample,]

predict(fix, ia1_p, type='response', na.fill=TRUE)

ia1_p <- pdata.frame(ia1_e, index = c("idem", "year"))

ia1_p['ed_bb_t'] = ifelse(ia1_p$ed_bb == 0, 1, 0)

ia1_p['mu0'] <- predict(fix, newdata=ia1_p, type="response")

ia1_p['mu0'] = ifelse(ia1_p$ed_bb==0 & !is.na(ia1_p$mu0),1,0)

```



```{r}
df_ee1 = select_col(pror1, ia1, c('idem','year',"ed_bb","Gini_netdm","Gov_ex","Education_expdm","Trade","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"he_bb","Gini_netdm","Gov_ex","Health_expdm","Trade","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"soc_bb","Gini_netdm","Gov_ex","Soc_payabledm",'gdp_gro',"Trade","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"kind_bb","Gini_netdm","Gov_ex","Soc_kinddm","Trade","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"prt_bb","Gini_netdm","Gov_ex","Property_taxesdm","Trade","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"indt_bb","Gini_netdm","Gov_ex","ind_txdm","Deficit"))

df_ee1 = select_col(pror1, ia1, c('idem','year',"pit_bb","Gini_netdm","gdp_grodm","PITdm","Gov_ex","Deficit"))

```

---- Learn predict & continue: Try one function of (1,2,3)

```{r}
# ln1['phat0'] = predict(pror, type = 'response')
ia1['phat0'] = predict(pror1,  type = 'response')
ia2['phat0'] = predict(pror1, type = 'response')
ia3['phat0'] = predict(pror1,  type = 'response')
ia4['phat0'] = predict(pror1,  type = 'response')
ia5['phat0'] = predict(pror1,  type = 'response')

plot(ia1$phat0, ia6$phat0)

```




```{r}
summary(ia1$phat0)

# TRUNCATE AT 10%

ia1['phat'] = ia1$phat0

lo = summary(ia1$phat0)[1]*1.1
up = .9*summary(ia1$phat0)[6]

ia1 <- ia1 %>% mutate(phat = ifelse(phat > up, up , ia1$phat))
ia1 <- ia1 %>% mutate(phat = ifelse(phat < lo, lo, ia1$phat))

summary(ia1$phat)

```

MODELO NO TRUNCADO

```{r}

ia1['invwt'] = ia1$ed_bb/ia1$phat + (1-ia1$ed_bb)/(1-ia1$phat)
ia2['invwt'] = ia2$Education_exp/ia2$phat0 + (1-ia2$Education_exp)/(1-ia2$phat0)
ia3['invwt'] = ia3$Education_exp/ia3$phat0 + (1-ia3$Education_exp)/(1-ia3$phat0)
ia4['invwt'] = ia4$Education_exp/ia4$phat0 + (1-ia4$Education_exp)/(1-ia4$phat0)
ia5['invwt'] = ia5$Education_exp/ia5$phat0 + (1-ia5$Education_exp)/(1-ia5$phat0)
ia6['invwt'] = ia6$Education_exp/ia6$phat0 + (1-ia6$Education_exp)/(1-ia6$phat0)

plot(ia1$invwt, phat)

```

MODELO TRUNCADO

```{r}

ia1['invwt'] = ia1$Education_exp/ia1$phat + (1-ia1$Education_exp)/(1-ia1$phat)
ia2['invwt'] = ia2$Education_exp/ia1$phat + (1-ia2$Education_exp)/(1-ia1$phat)
ia3['invwt'] = ia3$Education_exp/ia1$phat + (1-ia3$Education_exp)/(1-ia1$phat)
ia4['invwt'] = ia4$Education_exp/ia1$phat + (1-ia4$Education_exp)/(1-ia1$phat)
ia5['invwt'] = ia5$Education_exp/ia1$phat + (1-ia5$Education_exp)/(1-ia1$phat)
ia6['invwt'] = ia6$Education_exp/ia1$phat + (1-ia6$Education_exp)/(1-ia1$phat)

```

```{r}
library(lmtest)
library(sandwich)
library(clipr)
library(plm)
```

```{r}
fix <- plm(Gini_netdm ~ ed_bb + lag(gdp_gro) + lag(Gov_ex) +  Education_expdm + gdp_grodm , data=ia1, index=c("idem", "year"), model="within",weights = ia1$invwt)


summary(fix)

```


```{r}
# invr1 = lm(Gini_netdm ~ lag(gi_bb) +ed_bb + lag(Gov_ex) + employ_rate + idem -1, weights = invwt, data = ia1)

invr1 = gls(Gini_netdm ~ he_bb + lag(GDP_cycle) + lag(Gov_ex) + employ_rate -1 +idem, data=ia1, weights=varIdent(form = ~ invwt), na.action = na.omit, correlation = corAR1(form = ~ 1 | Gini_net))

# Education_expdm |gdp_grodm ~ Secondary_ed + Gov_ex + employ_rate + pop_gro
coef(summary(invr1))
summary(invr1)
intervals(invr1)

coefficients(invr1)[1]

ia1['mu0'] = (if_else(ia1$he_bb == 1, ia1$he_bb - coefficients(invr1)[1], 0))
ia1['mu1'] = (if_else(ia1$he_bb == 0, ia1$he_bb + coefficients(invr1)[1], 1))

ia1['mdiff'] = (-(ia1$gi_bb-ia1$phat)*ia1$mu1/ia1$phat)-((ia1$gi_bb-ia1$phat)*ia1$mu0/(1-ia1$phat))

plot(ia1$mdiff, Gini_net)

ia1['inv']= ((ia1$gi_bb/ia1$phat) + (1-ia1$gi_bb)/(1-ia1$phat))
ia1['iptw'] = (2*ia1$gi_bb-1)*(ia1$gi_bb*(ia1$inv))
plot((ia1$inv),Gini_net)

ia1['dr1'] = ia1$iptw+ia1$mdiff

summary(lm(mdiff ~ 1, data=ia1))
```

```{r}
invr1 <- gls(Gini_netdm ~ ed_bb +lag(Gini_net)+ lag(GDP_cycle) + lag(Gov_ex) -1,data=df, weights = varIdent(form = ~  invwt), na.action = na.omit, correlation = corAR1(form = ~ 1 | Gini_net))
```


```{r}

last_rf <- function(df, vari) {
  invr1 <- gls(Gini_netdm ~ he_bb +lag(Gini_net)+ lag(GDP_cycle) + lag(Gov_ex) +employ_rate -1 , data=df, weights = varIdent(form = ~  invwt), na.action = na.omit, correlation = corAR1(form = ~ 1 | Gini_net))
  # invr1 = lm(Gini_netdm ~ ed_bb +lag(GDP_cycle) + lag(Gov_ex) + employ_rate + idem -1, weights = invwt, data = ia1)
  
  df['mu0'] = (if_else(vari == 1, vari - coefficients(invr1)[1], 0))
  df['mu1'] = (if_else(vari == 0, vari + coefficients(invr1)[1], 1))

  df['mdiff'] = (-(df$he_bb-df$phat)*df$mu1/df$phat)-((df$he_bb-df$phat)*df$mu0/(1-df$phat))

  df['inv']= ((df$he_bb/df$phat) + (1-df$he_bb)/(1-df$phat))
  df['iptw'] = (2*df$he_bb-1)*(df$he_bb*df$inv)
    
  df['dr1'] = df$iptw+df$mdiff

   summary(lm(mdiff ~ 1, data=df))
}

my_list <- list(ia1, ia2, ia3, ia4, ia5)

lapply(my_list, function(x) last_rf(x,x$he_bb)) 



```


```{r}
ia1['pip_a'] = ia1$PIT*ia1$mrp_all
ia2['pip_a'] = ia2$PIT*ia2$mrp_all
ia3['pip_a'] = ia3$PIT*ia3$mrp_all
ia4['pip_a'] = ia4$PIT*ia4$mrp_all
ia5['pip_a'] = ia5$PIT*ia5$mrp_all
ia6['pip_a'] = ia6$PIT*ia6$mrp_all

```

Table 8.

```{r}
invr1 = opm(Gini_netdm ~ lag(gi_bb) +lag(gdp_grodm,1) + Education_expdm + lag(Gov_ex) + ed_bb, data = ia1, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt) 
# -- EDUCATION
summary(invr1)
# invr1 = lm(Gini_net ~ dplyr::lag(Gini_net,1) + dplyr::lag(Gini_netdm,1) + dplyr::lag(gdp_grodm,1) + (Health_exp) + Secondary_ed + employ_rate , weights = invwt, data = ia1) -- HEALTH

# invr1 = lm(Gini_net ~ dplyr::lag(Gini_netdm,1) + dplyr::lag(gdp_grodm,1) + dplyr::lag(gdp_grodm,2)+ dplyr::lag(Soc_payable,1)+dplyr::lag(Gov_ex,1)+Secondary_ed + employ_rate + dplyr::lag(Trade,1), weights = invwt, data = ia1) -- SOC PAYABLE

# invr1 = opm(Gini_net ~lag(gdp_gro,1) + Property_taxes + Gov_ex + Secondary_ed , data = ia1, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
# summary(invr1)

# invr1 = opm(Gini_net ~lag(gdp_gro,1) + ind_tx + Gov_ex + Secondary_ed , data = ia1, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
# summary(invr1) -- IND TAXES

# invr1 = opm(Gini_net ~lag(gdp_gro,1) + ia1$pip_a + mrp_all + PIT + Gov_ex + Secondary_ed , data = ia1, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
# summary(invr1) -- PIT

invr1 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia1, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr1)

invr2 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia2, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr2)

invr3 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia3, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr3)

invr4 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia4, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr4)

invr5 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia5, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr5)

invr6 = opm(Gini_net ~lag(gdp_gro,1) + Soc_kind + Gov_ex + Secondary_ed , data = ia6, index = c('idem','year'), n.samp = 10000, add.time.indicators = FALSE, weights=invwt)
summary(invr6)


caterplot(invr1, 'beta', labels = c('growth','E', 'D','D'))

kind_beta = cbind.data.frame(invr1[["samples"]][["beta"]][,2], invr2[["samples"]][["beta"]][,2],
                           invr3[["samples"]][["beta"]][,2], invr4[["samples"]][["beta"]][,2],
                           invr5[["samples"]][["beta"]][,2], invr6[["samples"]][["beta"]][,2])

colnames(kind_beta) <- c("1", "2","3", "4","5", "6" ) 

# PREDICTION

# mu0 = predict(invr, type = 'response')
mu01 = predict(invr1, type = 'response')

library(dplyr)
library(ggplot2)

ia1 %>%
        filter(idem %in% c("Cyprus")) %>%
        ggplot() +
        aes(x = year, y = Soc_kind, colour = idem) +
        geom_line(size = 0.5) +
        scale_color_hue(direction = 1) +
        theme_minimal()

plot(mu01[3:10])

```



```{r}
write.csv(ln1,"ln1.csv",row.names = FALSE)
write.csv(ia1,"ia1.csv",row.names = FALSE)
write.csv(ia2,"ia2.csv",row.names = FALSE)
write.csv(ia3,"ia3.csv",row.names = FALSE)
write.csv(ia4,"ia4.csv",row.names = FALSE)
write.csv(ia5,"ia5.csv",row.names = FALSE)
write.csv(ia6,"ia6.csv",row.names = FALSE)

```

```{r}
write.csv(b1,"b1.csv",row.names = FALSE)
write.csv(b2,"b2.csv",row.names = FALSE)
write.csv(b3,"b3.csv",row.names = FALSE)
write.csv(b4,"b4.csv",row.names = FALSE)

write.csv(bo1,"bo1.csv",row.names = FALSE)
write.csv(bo2,"bo2.csv",row.names = FALSE)
write.csv(bo3,"bo3.csv",row.names = FALSE)
write.csv(bo4,"bo4.csv",row.names = FALSE)
write.csv(bo5,"bo5.csv",row.names = FALSE)
write.csv(bo6,"bo6.csv",row.names = FALSE)
```

tABLE 3 iv BINARY TREATMENT


```{r}
library(lfe)

form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate + Secondary_ed -1 | year+idem | (Education_exp ~  ed_bb + pop_gro) |Gini_net | idem)

# form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate + Secondary_ed -1 |0 | (Health_exp ~ he_bb + pop_gro)  | idem) 

# form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate -1 |0 | (Soc_payable ~ soc_bb  )   | idem) 

# form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + Secondary_ed + employ_rate |0 | (Soc_kind ~ kind_bb + Quantiles )  | idem)

# form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate + Secondary_ed |0 | (Property_taxes ~ prt_bb  + year ) | idem)

form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate + Secondary_ed | 0 | (pip_a ~ pit_bb + mrp_all) | idem)

my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

wald_iv <- waldtest(my_iv_reg$stage1, ~ pit_bb, lhs=my_iv_reg$stage1$lhs)
print(c(wald_iv[5], wald_iv[1]))
``` 


```{r}

form_iv <- formula(Gini_netdm ~ lag(gi_bb,2) | idem |(Education_expdm |gdp_grodm ~ Secondary_ed + Gov_ex + employ_rate + pop_gro))
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg, robust=TRUE)

form_iv <- formula(Gini_netdm ~ lag(gi_bb,1) + Health_expdm -1 | idem | (gdp_grodm ~ Gov_ex + Secondary_ed  + employ_rate))
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

form_iv <- formula(Gini_netdm ~ lag(gi_bb,2) + Soc_payabledm -1 | idem | (gdp_grodm ~ Gov_ex + Secondary_ed + employ_rate + Deficit))
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

form_iv <- formula(Gini_netdm ~ lag(gi_bb) + Soc_kinddm | idem | (gdp_grodm ~ Gov_ex + Secondary_ed  + employ_rate + Deficit)|idem)
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

form_iv <- formula(Gini_netdm ~ lag(gi_bb,1) + Property_taxesdm -1 | idem | (gdp_grodm ~ Gov_ex + Secondary_ed + Deficit))
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

form_iv <- formula(Gini_netdm ~ lag(gi_bb,1) + PITdm*PIT -1 | idem | (gdp_grodm ~ Gov_ex + Secondary_ed  + Deficit))
my_iv_reg <- felm(form_iv, data = ia1)
summary(my_iv_reg)

coeftest(my_iv_reg, vcov = vcovHC, type = "HC1")
```
```{r}
dfList <- list(ia1,ia2,ia3,ia4,ia5)
form_iv <- formula(Gini_netdm ~ lag(gi_bb,2) | idem |(Education_expdm |gdp_grodm ~ Secondary_ed + Gov_ex + employ_rate + pop_gro))
lapply(dfList, function(x) {summary(felm(form_iv, data = x), robust=TRUE)} )
```



Table 6

```{r}
# form_iv <- formula(Gini_net ~ gdp_gro + Gov_ex + employ_rate -1 |0 | (Soc_payable ~ soc_bb  )   | idem) 

form_iv <- formula(Gini_net ~ Gov_ex|0 |(Soc_kind ~ kind_bb + Quantiles) | idem)

my_iv_reg <- felm(form_iv, data = ln1)
summary(my_iv_reg)

wald_iv <- waldtest(my_iv_reg$stage1, ~ kind_bb, lhs=my_iv_reg$stage1$lhs)
print(c(wald_iv[5], wald_iv[1]))
```

```{r}
attach(ia1)
```

```{r}
model_net_naive <- lm(Gini_net ~ Education_exp, data = ia1)
tidy(model_net_naive)
```

Crear una formula para cada modelo y DB, para un solo DF (no ocupe espacio)

```{r}
model_predict_net <- glm(he_bb ~ lag(Gini_net,1) + lag(Health_exp,1) +lag(gdp_gro,1)+ Gov_ex + idem -1, data=ia1,
                         family = binomial(link = "logit"),
                         ,na.action = na.exclude)

# Generate propensity scores and IPWs
net_data_ipw <- augment_columns(model_predict_net, ia1,
            type.predict = "response") %>%  rename(propensity = .fitted) %>% 
             mutate(ipw = (ed_bb/propensity) + ((1-ed_bb)/(1-propensity)))

net_data_ipw %>% 
  select(idem, year, Gini_net, gi_bb, GDP_bb, gdppc_gro, Education_exp, ed_bb, Gov_ex, propensity, ipw) %>% 
  head()
```


```{r}
model_net_ipw <- lm(Gini_net ~ Education_exp, data = net_data_ipw, weights = ipw)
tidy(model_net_ipw)

```
```{r}
# ipwpoint() can't handle tibbles! Force net_data to be a data.frame
weights_ipwpoint <- ipwpoint(exposure = ed_bb,
  family = "binomial",  # The treatment is binary
  link = "logit",
  denominator = ~ gdppc_gro + Education_exp + Gov_ex,
  data = as.data.frame(na.omit(ia1)))

# They're the same!
head(weights_ipwpoint$ipw.weights)
## [1] 1.61 1.59 2.93 1.36 1.68 1.85
head(net_data_ipw$ipw)
## [1] 1.61 1.59 2.93 1.36 1.68 1.85
```


```{r}
ia1c = na.omit(ia1)

net_data_ipwpoint <- ia1c %>% 
  mutate(ipw = weights_ipwpoint$ipw.weights)

model_net_ipwpoint <- lm(Gini_net ~ Education_exp, 
                         data = net_data_ipwpoint, weights = ipw)
tidy(model_net_ipwpoint)

```


```{r}
weights_weightit <- weightit(ed_bb ~ gdppc_gro + Gov_ex,  # Model net use with confounders
                             data = ia1c, 
                             estimand = "ATE",  # Find the ATE
                             method = "ps", include.obj = TRUE)  # Build weights with propensity scores
weights_weightit$weights
```


```{r}
net_data_weightit <- ia1c %>% 
  mutate(ipw = weights_weightit$weights)

model_net_weightit <- lm(Gini_net ~ ed_bb, 
                         data = net_data_weightit, weights = ipw)

tidy(model_net_weightit)
```


```{r}
fit <- lm(speed ~ dist, data= cars)

esample.n <- nobs(fit)
```


```{r}
esample<-rownames(as.matrix(resid(fit)))

cars[esample,]
```

```{r}
pror1 = glm(he_bb ~ lag(Gini_net,1) + lag(Health_exp,1) +lag(gdp_gro,1)+ Gov_ex + idem -1, data=ia1, family=binomial(link="probit"), na.action = na.exclude)
summ(pror1)
```


```{r}
ia1['phat0'] = predict(pror1,  type = 'response')
```


```{r}
esample.n <- nobs(pror1)
```


```{r}
esample<-rownames(as.matrix(resid(pror1)))
esample.n <- nobs(fit)
```


```{r}
esample<-rownames(as.matrix(pror1$fitted.values))
esample.n <- nobs(pr)

ia1_e = ia1[esample,]
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


