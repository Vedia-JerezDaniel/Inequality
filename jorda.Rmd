---
title: "jorda"
output: html_document
date: '2022-05-07'
---


```{r,message=FALSE}
library(tidyverse)
library(lpirfs)
library(dplyr)
```

```{r}
library(readr)

ln1 <- read_delim("ln1.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia1 <- read_delim("ia1.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia2 <- read_delim("ia2.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia3 <- read_delim("ia3.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia4 <- read_delim("ia4.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia5 <- read_delim("ia5.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)
ia6 <- read_delim("ia6.csv", delim = ",", escape_double = FALSE, trim_ws = TRUE)


z = list(ia1,ia2,ia3,ia4,ia5,ia6)

ln1['id'] = as.numeric(as.factor(ln1$idem))
ia1['id'] = as.numeric(as.factor(ia1$idem))
ia2['id'] = as.numeric(as.factor(ia2$idem))
ia3['id'] = as.numeric(as.factor(ia3$idem))
ia4['id'] = as.numeric(as.factor(ia4$idem))
ia5['id'] = as.numeric(as.factor(ia5$idem))
ia6['id'] = as.numeric(as.factor(ia6$idem))

```

```{r}
# ln1 <- ln %>% drop_na()
# pror = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ln1, family=binomial(link="probit"), na.action = na.exclude)

pror1 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia1, family=binomial(link="probit"), na.action = na.exclude)
# 
# pror2 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia2, family=binomial(link="probit"), na.action = na.exclude)
# 
# pror3 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia3, family=binomial(link="probit"), na.action = na.exclude)
# 
# pror4 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia4, family=binomial(link="probit"), na.action = na.exclude)
# 
# pror5 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia5, family=binomial(link="probit"), na.action = na.exclude)
# 
# pror6 = glm(gi_bb ~ lag(Gini_net,1) + gdp_gro + Gov_ex , data=ia6, family=binomial(link="probit"), na.action = na.exclude)


# ln1['phat0'] = predict(pror, type = 'response')
ia1['phat0'] = predict(pror1, type = 'response')
ia2['phat0'] = ia1$phat0
ia3['phat0'] = ia1$phat0
ia4['phat0'] = ia1$phat0
ia5['phat0'] = ia1$phat0
ia6['phat0'] = ia1$phat0

```


```{r}
summary(ia1$phat0)

# TRUNCATE AT 10%

ia1['phat'] = ia1$phat0

ia1 <- ia1 %>% mutate(phat = ifelse(ia1['phat'] > 0.55, 0.55, ia1$phat))
ia1 <- ia1 %>% mutate(phat = ifelse(ia1['phat'] < 0.4, 0.4, ia1$phat))

summary(ia1$phat)

names(ia1)[40] <- 'id'
names(ia1)[41] <- 'phat'
```


```{r}

ia1['invwt'] = ia1$gi_bb/ia1$phat0 + (1-ia1$gi_bb)/(1-ia1$phat0)
ia2['invwt'] = ia2$gi_bb/ia2$phat0 + (1-ia2$gi_bb)/(1-ia2$phat0)
ia3['invwt'] = ia3$gi_bb/ia3$phat0 + (1-ia3$gi_bb)/(1-ia3$phat0)
ia4['invwt'] = ia4$gi_bb/ia4$phat0 + (1-ia4$gi_bb)/(1-ia4$phat0)
ia5['invwt'] = ia5$gi_bb/ia5$phat0 + (1-ia5$gi_bb)/(1-ia5$phat0)
ia6['invwt'] = ia6$gi_bb/ia6$phat0 + (1-ia6$gi_bb)/(1-ia6$phat0)

```

```{r}
library(lmtest)
library(sandwich)
library(plm)

# invr = plm(Gini_net ~ gdp_gro + Secondary_ed + employ_rate + Gov_ex + Trade + gi_bb, weights = ln1$invmt, data = ln1, na.action = na.exclude, model = "within")

invr1 = plm(ia1$Gini_net ~ ia1$gdp_gro + ia1$Secondary_ed + ia1$employ_rate + ia1$Gov_ex + ia1$Trade + ia1$gi_bb , weights = ia1$invwt, data = ia1, na.action = na.exclude, model = "within")

invr2 = plm(ia2$Gini_net ~ ia2$gdp_gro + ia2$Secondary_ed + ia2$employ_rate + ia2$Gov_ex + ia2$Trade + ia2$gi_bb, weights = ia2$invwt, data = ia2, na.action = na.exclude, model = "within")

invr3 = plm(ia3$Gini_net ~ ia3$gdp_gro + ia3$Secondary_ed + ia3$employ_rate + ia3$Gov_ex + ia3$Trade + ia3$gi_bb, weights = ia3$invwt, data = ia3, na.action = na.exclude, model = "within")

invr4 = plm(ia4$Gini_net ~ ia4$gdp_gro + ia4$Secondary_ed + ia4$employ_rate + ia4$Gov_ex + ia4$Trade + ia4$gi_bb, weights = ia4$invwt, data = ia4, na.action = na.exclude, model = "within")

invr5 = plm(ia5$Gini_net ~ ia5$gdp_gro + ia5$Secondary_ed + ia5$employ_rate + ia5$Gov_ex + ia5$Trade + ia5$gi_bb, weights = ia5$invwt, data = ia5, na.action = na.exclude, model = "within")

invr6 = plm(ia6$Gini_net ~ ia6$gdp_gro + ia6$Secondary_ed + ia6$employ_rate + ia6$Gov_ex + ia6$Trade + ia6$gi_bb, weights = ia6$invwt, data = ia6, na.action = na.exclude, model = "within")

summary(invr3, cluster=c('iden'))

# z2 = list(invr1, invr2)

tmr = coeftest(invr1)

# PREDICTION

# mu0 = predict(invr, type = 'response')
mu01 = predict(invr1, type = 'response')
mu02 = predict(invr2, type = 'response')
mu03 = predict(invr3, type = 'response')
mu04 = predict(invr4, type = 'response')
mu05 = predict(invr5, type = 'response')
mu06 = predict(invr6, type = 'response')

# ln1['mu'] = mu0*ln1$trend/ln1$trend
ia1['mu'] = mu01*ia1$trend/ia1$trend
ia2['mu'] = mu02*ia2$trend/ia2$trend
ia3['mu'] = mu03*ia3$trend/ia3$trend
ia4['mu'] = mu04*ia4$trend/ia4$trend
ia5['mu'] = mu05*ia5$trend/ia5$trend
ia6['mu'] = mu06*ia6$trend/ia6$trend


# ln1 <- ln1 %>% mutate(mu0 = if_else(ln1$gi_bb == 0, 1, 0))
# ln1['mu0'] = ln1$mu0*ln1$mu
# ln1 <- ln1 %>% mutate(mu1 = if_else(ln1$gi_bb == 1, 1, 0))
# ln1['mu1'] = ln1$mu1*ln1$mu

ia1 <- ia1 %>% mutate(mu0 = if_else(ia1$gi_bb == 0, 1, 0))
ia1['mu0'] = ia1$mu0*ia1$mu
ia1 <- ia1 %>% mutate(mu1 = if_else(ia1$gi_bb == 1, 1, 0))
ia1['mu1'] = ia1$mu1*ia1$mu

ia2 <- ia2 %>% mutate(mu0 = if_else(ia2$gi_bb == 0, 1, 0))
ia2['mu0'] = ia2$mu0*ia2$mu
ia2 <- ia2 %>% mutate(mu1 = if_else(ia2$gi_bb == 1, 1, 0))
ia2['mu1'] = ia2$mu1*ia2$mu

ia3 <- ia3 %>% mutate(mu0 = if_else(ia3$gi_bb == 0, 1, 0))
ia3['mu0'] = ia3$mu0*ia3$mu
ia3 <- ia3 %>% mutate(mu1 = if_else(ia3$gi_bb == 1, 1, 0))
ia3['mu1'] = ia3$mu1*ia3$mu

ia4 <- ia4 %>% mutate(mu0 = if_else(ia4$gi_bb == 0, 1, 0))
ia4['mu0'] = ia4$mu0*ia4$mu
ia4 <- ia4 %>% mutate(mu1 = if_else(ia4$gi_bb == 1, 1, 0))
ia4['mu1'] = ia4$mu1*ia4$mu

ia5 <- ia5 %>% mutate(mu0 = if_else(ia5$gi_bb == 0, 1, 0))
ia5['mu0'] = ia5$mu0*ia5$mu
ia5 <- ia5 %>% mutate(mu1 = if_else(ia5$gi_bb == 1, 1, 0))
ia5['mu1'] = ia5$mu1*ia5$mu

ia6 <- ia6 %>% mutate(mu0 = if_else(ia6$gi_bb == 0, 1, 0))
ia6['mu0'] = ia6$mu0*ia6$mu
ia6 <- ia6 %>% mutate(mu1 = if_else(ia6$gi_bb == 1, 1, 0))
ia6['mu1'] = ia6$mu1*ia6$mu


ln1['mdiff1']=(-(ln1$gi_bb -ln1$phat0)*ln1$mu1/ln1$phat0)-((ln1$gi_bb -ln1$phat0)*ln1$mu0/(1-ln1$phat0))
ln1['iptw'] = (2*ln1$gi_bb-1)*ln1$Gini_net*ln1$invwt
ln1['dr1']=ln1$iptw + ln1$mdiff1

ia1['mdiff1']=(-(ia1$gi_bb -ia1$phat0)*ia1$mu1/ia1$phat0)-((ia1$gi_bb -ia1$phat0)*ia1$mu0/(1-ia1$phat0))
ia1['iptw'] = (2*ia1$gi_bb-1)*ia1$Gini_net*ia1$invwt
ia1['dr1']=ia1$iptw + ia1$mdiff1

ia2['mdiff1']=(-(ia2$gi_bb -ia2$phat0)*ia2$mu1/ia2$phat0)-((ia2$gi_bb -ia2$phat0)*ia2$mu0/(1-ia2$phat0))
ia2['iptw'] = (2*ia2$gi_bb-1)*ia2$Gini_net*ia2$invwt
ia2['dr1']=ia2$iptw + ia2$mdiff1

ia3['mdiff1']=(-(ia3$gi_bb -ia3$phat0)*ia3$mu1/ia3$phat0)-((ia3$gi_bb -ia3$phat0)*ia3$mu0/(1-ia3$phat0))
ia3['iptw'] = (2*ia3$gi_bb-1)*ia3$Gini_net*ia3$invwt
ia3['dr1']=ia3$iptw + ia3$mdiff1

ia4['mdiff1']=(-(ia4$gi_bb -ia4$phat0)*ia4$mu1/ia4$phat0)-((ia4$gi_bb -ia4$phat0)*ia4$mu0/(1-ia4$phat0))
ia4['iptw'] = (2*ia4$gi_bb-1)*ia4$Gini_net*ia4$invwt
ia4['dr1']=ia4$iptw + ia4$mdiff1

ia5['mdiff1']=(-(ia5$gi_bb -ia5$phat0)*ia5$mu1/ia5$phat0)-((ia5$gi_bb -ia5$phat0)*ia5$mu0/(1-ia5$phat0))
ia5['iptw'] = (2*ia5$gi_bb-1)*ia5$Gini_net*ia5$invwt
ia5['dr1']=ia5$iptw + ia5$mdiff1

ia6['mdiff1']=(-(ia6$gi_bb -ia6$phat0)*ia6$mu1/ia6$phat0)-((ia6$gi_bb -ia6$phat0)*ia6$mu0/(1-ia6$phat0))
ia6['iptw'] = (2*ia6$gi_bb-1)*ia6$Gini_net*ia6$invwt
ia6['dr1']=ia6$iptw + ia6$mdiff1


```


```{r}
write.csv(ln1,"ln1.csv",row.names = FALSE)
write.csv(ia1,"ia1.csv",row.names = FALSE)
write.csv(ia2,"ia2.csv",row.names = FALSE)
write.csv(ia3,"ia3.csv",row.names = FALSE)
write.csv(ia4,"ia4.csv",row.names = FALSE)
write.csv(ia5,"ia5.csv",row.names = FALSE)
write.csv(ia6,"ia6.csv",row.names = FALSE)
```

```{r}
ia1['ate'] = 1
ia2['ate'] = 1
ia3['ate'] = 1
ia4['ate'] = 1
ia5['ate'] = 1
ia6['ate'] = 1


ouv1 = plm(ia1$dr1 ~ ate ,  weights = ia1$invwt, data = ia1, na.action = na.exclude, model = "pooling")
summary(ouv1)

t= lm(ia1$dr1 ~ ate  -1 +id ,  weights = ia1$invwt,data = ia1, na.action = na.exclude)
summary(t)


tc <- data.frame(summary(t)$coefficients)
tc_1 <- which(!startsWith(row.names(tc), 'id'))
view(tc[1,])
tc[1,]

t_cl <- coeftest(t, vcov = vcovCL, cluster = ~ id)
t_cl[tc_1,]

all(near(m1, t_cl[,2]))

ouv2 = plm(ia2$Gini_net ~ ia2$gdp_gro + ia2$Secondary_ed + ia2$employ_rate + ia2$Gov_ex + ia2$Trade + ia2$gi_bb, weights = ia2$invwt, data = ia2, na.action = na.exclude, model = "within")

ouv3 = plm(ia3$Gini_net ~ ia3$gdp_gro + ia3$Secondary_ed + ia3$employ_rate + ia3$Gov_ex + ia3$Trade + ia3$gi_bb, weights = ia3$invwt, data = ia3, na.action = na.exclude, model = "within")

ouv4 = plm(ia4$Gini_net ~ ia4$gdp_gro + ia4$Secondary_ed + ia4$employ_rate + ia4$Gov_ex + ia4$Trade + ia4$gi_bb, weights = ia4$invwt, data = ia4, na.action = na.exclude, model = "within")

ouv5 = plm(ia5$Gini_net ~ ia5$gdp_gro + ia5$Secondary_ed + ia5$employ_rate + ia5$Gov_ex + ia5$Trade + ia5$gi_bb, weights = ia5$invwt, data = ia5, na.action = na.exclude, model = "within")

ouv6 = plm(ia6$Gini_net ~ ia6$gdp_gro + ia6$Secondary_ed + ia6$employ_rate + ia6$Gov_ex + ia6$Trade + ia6$gi_bb, weights = ia6$invwt, data = ia6, na.action = na.exclude, model = "within")

```




```{r}
library(webuse)
library(dplyr)

nlswork_orig <- webuse('nlswork')

nlswork <- filter(nlswork_orig, idcode <= 100) %>%
  select(idcode, year, ln_wage, age, tenure, union) %>%
  filter(complete.cases(.)) %>%
  mutate(union = as.integer(union),
         idcode = as.factor(idcode))
str(nlswork)

ia1$id = as.factor(ia1$id)

```


ROBUST CLUSTER STANDARD ERRORS SOLO AL FINAL

```{r}
X <- model.matrix(t)
u <- residuals(t)
n <- nobs(t)
p <- ncol(X)
sigma2 <- sum(u^2,na.rm = TRUE) / (n - p)
# solve (X^T X) A = I, where I is identity matrix -> A is (X^T X)^-1
crossXinv <- solve(t(X) %*% X, diag(p))

m1se <- sqrt(diag(sigma2 * crossXinv))
m1se

```


```{r}
omegaj <- lapply(levels(ia1$id), function(idc) {
  j <- levels(factor(ia1$id)) == idc
  # drop = FALSE: don't drop dimensions when we have only one obs.
  X_j <- X[j, , drop = TRUE]
  # tcrossprod is outer product x * x^T
  t(X_j) %*% tcrossprod(u[j]) %*% X_j
})


n_cl <- length(levels(ia1$id))
omega <- (n-1) / (n-p) * (n_cl / (n_cl-1)) * Reduce('+', omegaj)
m1clse <- sqrt(diag(crossXinv %*% omega %*% crossXinv)) 
m1clse
m1se

```


```{r}
library(miceadds)
library(margins)

m2 <- lm.cluster(dr1 ~ ate -1 + id, cluster = 'id',  data = ia1)
summary(m2)

mdr1 = mean(ia1$dr1, na.rm = TRUE)
isq = mean((ia1$dr1 - mdr1)^2, na.rm = TRUE)
rsd = sqrt(isq/nrow(ia1))
# añadir rsf al std.error final

```


```{r}

```