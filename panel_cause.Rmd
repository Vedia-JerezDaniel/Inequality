---
title: "Base sample"
output:
  html_document:
    df_print: paged
---


```{r, message=FALSE}
library(readxl)

final <- read_excel("final.xlsx")

```



```{r,message=FALSE}
library(plm)
library(tidyverse)
library(lfe)
library(lmtest)
```

```{r}
final <- final %>%
  arrange(idem, year) %>%  # Sort by firm and then by year
  group_by(idem) %>%      # Tell dplyr to go within each firm
  mutate(gdppc_gro = GDP_pc/(lag(GDP_pc)-1),
         gdp_gro = GDP/(lag(GDP)-1),
         insde_d = ins_effic/(lag(ins_effic)-1),
         tot_d = TOT/(lag(TOT)-1), 
         debt_d = Gov_debt/(lag(Gov_debt)-1),
         redis = Gini_market - Gini_net/Gini_net)


panel.plm.df <- pdata.frame(final, index=c("idem","year"), drop.index=TRUE)

attach(panel.plm.df)
```

Resultados de un modelo con fixed effects y pooling

```{r}
fe_lm <- plm(Gini_net ~ (gdp_gro) + Unempl_rate + Trade + Gov_ex + Secondary_ed ,
                        data = panel.plm.df, 
                        index=c("idem", "year"), model="within", effect = c("individual"))
summary(fe_lm)

yhat <- fe_lm$fitted
plot(final$gdp_gro, final$Gini_net, pch=19, xlab="GDP growth", ylab="Gini_net")
abline(lm(final$Gini_net~final$gdp_gro),lwd=3, col="red")

pl_lm <- plm(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed ,
                        data = panel.plm.df, 
                        index=c("idem", "year"), model="pooling", effect = c("individual"))

summary(pl_lm)
```

```{r}
library(gplots)
plotmeans(Gini_net ~ idem, main="Heterogeineity across countries", data=final, bars=T, lwd=2)

# Mejorar por 3 grupos
```


```{r}
pFtest(fe_lm, pl_lm)

# In both cases the null hypothesis is rejected in favor of the alternative that there are significant fixed effects.

```

```{r}
wi_lm <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed ,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("twoways"))

summary(wi_lm)

pFtest(fe_lm, wi_lm) 

# There is evidence that time fixed effects should be taken into account.
```


```{r, eval=FALSE}
ra_lm <- plm(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed ,
                        data = panel.plm.df, 
                        index=c("idem", "year"), model="random", effect = c("individual"))

summary(ra_lm)
summary(fe_lm)

phtest(fe_lm, ra_lm)

# The null hypothesis cannot be rejected here, hence we should use a FE model.
```

```{r}
lmtest::bptest(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed + factor(idem), studentize = F, data = final)

# here is strong evidence for the presense of heteroskedasticity. Hence, the use of robust standard errors is advised.

pbgtest(fe_lm)

# There is strong evidence that the residuals are serially correlated.
```

```{r}
fe_s =coeftest(fe_lm, vcov = (vcovHC(fe_lm, method='arellano',type = "HC1",cluster = "group")))

fe_s
# summary(fe_lm)

# fe_s2 <- lfe::felm(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed | idem | 0 | idem, data = final)
# 
# summary(fe_s2)

wi_s =coeftest(wi_lm, vcov = (vcovHC(wi_lm, method='arellano',type = "HC2",cluster = "group")))

wi_s

# ercomp(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed, data=final, 
       # method = "nerlove", effect = "twoways")

```

De los resultados anteriores solucionando los problemas de autocorrelación y heteroscedasticidad, vemos que controlando el modelo por tiempo y fixed effects es mejor que sólo con FE.


```{r}
ftime <- plm(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade  + Gov_ex + Secondary_ed  + factor(year),    data = final, index=c("idem","year"), model="within")

summary(ftime)

pFtest(wi_lm, fe_lm)
plmtest(fe_lm, c("time"), type=("bp"))

# If this number is < 0.05 then use time-fixed effects. In this example, no need to use
# time-fixed effects.
```

```{r}
# Testing for cross-sectional dependence

# Evidence of CS dependence and Correlation

pcdtest(fe_lm, test = c("lm"))
pcdtest(fe_lm, test = c("cd"))

pbgtest(fe_lm)

# Presence of heteroskedasticity
bptest(Gini_net ~ lag(GDP_pc) + lag(Gini_market) + Trade + instdepth + Gov_ex + Secondary_ed  + factor(idem), data = final, studentize=F)

coeftest(fe_lm)

fe_so1 <- coeftest(fe_lm, vcovHC(fe_lm, method = "arellano",  type = "HC3"))
fe_so2 <- coeftest(fe_lm, vcovHC(fe_lm, cluster = "group",  type = "HC3"))

wi_so1 <- coeftest(wi_lm, vcovHC(wi_lm, method = "arellano",  type = "HC3"))
wi_so2 <- coeftest(wi_lm, vcovHC(wi_lm, type = "HC3", cluster = "group"))

library(texreg)

screenreg(list(fe_so1, fe_so2, wi_so2),
          custom.model.names = c("FE_au", "FE_cd", "Two"))

wi_so2[,1] / diff(range(final$Gini_net, na.rm = TRUE))
```

## Adding external variables

## leer para estimacion final
https://cran.r-project.org/web/packages/plm/vignettes/A_plmPackage.html


```{r}
fe_1 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate + Trade + Gov_ex + Secondary_ed +
                Soc_payable,
                        data = panel.plm.df, 
                        index=c("idem", "year"), model="within", effect = c("individual"))
fe_2 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate + Trade + Gov_ex + Secondary_ed +
                Soc_kind,
                        data = panel.plm.df, 
                        index=c("idem", "year"), model="within", effect = c("individual"))
fe_3 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate +Trade +  Gov_ex + Education_exp,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("individual"))
fe_4 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate +Trade +  Gov_ex + Secondary_ed + Health_exp,  data = panel.plm.df, index=c("idem", "year"), model="within", effect = c("individual"))
fe_5 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate +Trade +  Gov_ex + Secondary_ed + Social_prot,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("individual"))
fe_6 <- plm(Gini_net ~ (gdp_gro) + Unempl_rate +Trade +  Gov_ex + Secondary_ed + Family,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("individual"))


wi_1 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + Soc_payable,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("twoways"))

wi_2 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + Soc_kind,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("twoways"))
wi_3 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Education_exp,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("twoways"))
wi_4 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + Health_exp,  data = panel.plm.df, index=c("idem", "year"), model="within", effect = c("twoways"))
wi_5 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + Social_prot,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))
wi_6 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + Family,  data = panel.plm.df, 
   index=c("idem", "year"), model="within", effect = c("twoways"))
wi_7 <- plm(Gini_net ~ (gdp_gro) +employ_rate +Trade +  Gov_ex + Secondary_ed + Wages,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))

wi_8 <- plm(Gini_net ~ (gdp_gro) +employ_rate +Trade +  Gov_ex + Secondary_ed + arp_mid*PIT,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))
wi_9 <- plm(Gini_net ~ (gdp_gro) +employ_rate +Trade +  Gov_ex + Secondary_ed + mrp_all*PIT,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))

fe_ex1 <- coeftest(fe_1, vcovHC(fe_1, method = "arellano", cluster = 'group',type = "HC3"))
fe_ex2 <- coeftest(fe_2, vcovHC(fe_2, method  = "arellano", cluster = 'group', type = "HC3"))
fe_ex3 <- coeftest(fe_3, vcovHC(fe_3, method = "arellano", cluster = 'group',type = "HC3"))
fe_ex4 <- coeftest(fe_4, vcovHC(fe_4, method  = "arellano", cluster = 'group', type = "HC3"))
fe_ex5 <- coeftest(fe_5, vcovHC(fe_5, method = "arellano", cluster = 'group',type = "HC3"))
fe_ex6 <- coeftest(fe_6, vcovHC(fe_6, method  = "arellano", cluster = 'group', type = "HC3"))


wi_ex1 <- coeftest(wi_1, vcovHC(wi_1, method = "arellano",  cluster = 'time', type = "HC3"))
wi_ex2 <- coeftest(wi_2, vcovHC(wi_2, type = "HC3", cluster = 'time', method  = "arellano"))
wi_ex3 <- coeftest(wi_3, vcovHC(wi_3, method = "arellano",  cluster = 'time', type = "HC3"))
wi_ex4 <- coeftest(wi_4, vcovHC(wi_4, type = "HC3", cluster = 'time', method  = "arellano"))
wi_ex5 <- coeftest(wi_5, vcovHC(wi_5, method = "arellano",  cluster = 'time', type = "HC3"))
wi_ex6 <- coeftest(wi_6, vcovHC(wi_6, type = "HC3", cluster = 'time', method  = "arellano"))

wi_ex8 <- coeftest(wi_8, vcovHC(wi_8, method = "arellano",  cluster = 'time', type = "HC3"))
wi_ex9 <- coeftest(wi_9, vcovHC(wi_9, type = "HC3", cluster = 'time', method  = "arellano"))

screenreg(list(fe_ex1, fe_ex2,fe_ex3, fe_ex4,fe_ex5, fe_ex6),
          custom.model.names = c("FE_1", "FE_2", "FE_3", "FE_4","FE_5","FE_6"))

screenreg(list(wi_ex1, wi_ex2, wi_ex3, wi_ex4, wi_ex5, wi_ex6, wi_ex9),
          custom.model.names = c("TE_1", "TE_2", "TE_3", "TE_4", "TE_5", "TE_6", "TE_9"))

# Analizando resultados (obteniendo parámetros)
wi_ex1[,1] / diff(range(final$Gini_net, na.rm = T))
```

##  ASSESING TECH

```{r}
wi_rd <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed +  res_1mill,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))

wi_rd1 <- plm(Gini_net ~ (gdp_gro) + employ_rate +Trade +  Gov_ex + Secondary_ed + res_1mill*pro_imp_tx,  data = panel.plm.df,  index=c("idem", "year"), model="within", effect = c("twoways"))

summary(wi_rd1)

plot(final$PIT, final$Gini_net)
abline(lm(final$Gini_net~final$PIT), col="red") # regression line (y~x)

plot(final$pro_imp_tx, final$Gini_net)
abline(lm(final$Gini_net~final$pro_imp_tx), col="blue")

library("car")
scatterplot(final$Gini_net ~ final$pro_imp_tx | debt_g, data = final, smooth=T, col=c('blue','orange'))

scatterplot(final$Gini_net ~ final$PIT | debt_g, data = final, smooth=F, col=c('blue','orange'))

scatterplot(final$Gini_net ~ final$PIT, data = final, smooth=list(smoother=quantregLine, var=T, span=1, lwd=4, lwd.var=2, border=F),regLine=F)
```


##  ASSESING SAVINGS + TECH

```{r}
wi_sv <- plm(Gini_net ~ gdp_gro + employ_rate +Trade + Gov_ex + Secondary_ed + Savings_percapit*res_1mill,  data = panel.plm.df, index=c("idem", "year"), model="within", effect = c("twoways"))
summary(wi_sv)

plot(final$Savings_percapit, final$Gini_net)
abline(lm(final$Gini_net~final$Savings_percapit), col="red") # regression line (y~x)

plot(final$pro_imp_tx, final$Gini_net)
abline(lm(final$Gini_net~final$pro_imp_tx), col="blue")

library("car")
scatterplot(final$Gini_net ~ final$pro_imp_tx | debt_g, data = final, smooth=T, col=c('blue','orange'))

scatterplot(final$res_1mill ~ final$Savings_percapit | debt_g, data = final, smooth=T, col=c('blue','orange'))

scatter3d(x = final$Savings_percapit, y = final$Gini_net, z = final$res_1mill, point.col = "blue", surface=FALSE)

LETTER2num <- function(x) {utf8ToInt(x) - utf8ToInt("A") + 1L}

colors <- unname(sapply(final$debt_g, LETTER2num))

sd <- scatterplot3d(x = Savings_percapit, z = Gini_net, y = res_1mill, color=colors,pch = 16)
legend('bottomright', legend = levels(lev), col =  c("1", "2"), pch = 15, xpd = TRUE, horiz = TRUE, inset = 0.025)

my.lm <- lm(final$Gini_net ~ final$Savings_percapit + final$res_1mill )
sd$plane3d(my.lm, col='blue')

lev = factor(final$debt_g, levels= c("A", "B"))
```

## LOCAL IMPULSE ESTIMATIONS

```{r}
library(lpirfs)
library(dplyr)
```

```{r}
ln <- final %>%
             dplyr::select(idem, year, Gini_net, GDP_pc, Trade, instdepth, Gov_ex, Secondary_ed)
```

```{r}
results_panel <-  lp_lin_panel(data_set          = ln,
                              # data_sample       = data_sample,
                               endog_data        = "Gini_net",
                               cumul_mult        = TRUE,
                               shock             = "Gov_ex",
                               diff_shock        = T,
                               panel_model       = "within",
                               panel_effect      = "twoways",
                               robust_cov        = "vcovSCC",
                               # c_exog_data       = "Gov_ex",
                               c_fd_exog_data    = colnames(ln)[c(seq(4,8))],
                               l_fd_exog_data    = colnames(ln)[c(seq(4,8))],
                               lags_fd_exog_data = 1,
                               confint           = 1.67,
                               hor               = 10)
```


```{r}
plot_lin_panel <- plot_lin(results_panel)

plot(plot_lin_panel[[1]])

## Government exp shock on Gini_net
```

```{r}
en = ln %>% select(-idem, -year)
en$idem <- NULL

results_lin <- lp_lin(en, 
                           lags_endog_lin = 1,    # Number of lags for endogenous data
                           trend          = 0,    # 0 = no trend, 1 = trend, 2 = trend & trend^2    
                           shock_type     = 1,    # 0 = standard deviation shock, 1 = unit shock
                           confint        = 1.96, # Width of confidence bands: 
                                                  # 1 = 68%, 1.67 = 90%, 1.96 = 95%
                           hor            = 5)   # Number of cores to use. When NULL, the number of cores 
                                                  # is chosen automatically 
```

```{r}
 linear_plots <- plot_lin(results_lin)
  library(ggpubr)
  library(gridExtra)

# Show all plots

lin_plots_all <- sapply(linear_plots[1:6], ggplotGrob)
marrangeGrob(lin_plots_all, nrow = 2, ncol = 3, top = NULL)
```

Efectos locales sobre el Gini-net, solo es una muestra (no definitivo) falta mejorar los parámetros de la estimación.
Y que otras opciones arrojan los resultados... y lo más importante theory!!!

Yo me quedaría con el de arriba que es la de Panel y se puede modificar las variables, solo que tenemos que tener claro que shocks deben afectar al Gini.

Ningún modelo es dinámico, ya va tomando forma.
